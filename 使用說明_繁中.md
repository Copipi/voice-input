# voice-input（Windows）繁體中文使用說明

這個工具可以把你講的話轉成文字，並用本機 LLM 幫你「去掉口頭禪/贅字、補標點、整理成更好讀的內容」。
如果你有開啟「螢幕情境」，它也會把你當下的畫面截圖交給 Vision 模型分析，讓轉寫更貼近你正在做的事。

> 全程本機執行：語音與截圖不需要上傳到雲端。

---

## 1) 使用前需要先安裝什麼？

### 必裝

1. **Python 3.10+**
2. **Ollama（本機 LLM 服務）**
   - 你已經安裝好，且服務在：`http://127.0.0.1:11434`
3. **Ollama 模型**（至少要有）
   - 文字整形模型：`gemma3:4b`
   - 螢幕情境（Vision）模型：`qwen3-vl:8b-instruct`

### 需要的 Python 套件（第一次才要做）

在專案資料夾中開 PowerShell，執行：

```powershell
uv venv
uv pip install --python .venv\Scripts\python.exe -r requirements.txt

# Windows client 需要
uv pip install --python .venv\Scripts\python.exe sounddevice numpy websockets pynput pyperclip

# （建議）避免 Word 觸發 F8「延伸選取」
uv pip install --python .venv\Scripts\python.exe keyboard

# 如果要開啟「螢幕情境截圖」才需要
uv pip install --python .venv\Scripts\python.exe pillow
```

> Whisper 模型會在 server 啟動時自動下載，預設會快取在本專案的 `models\whisper\`。
> 你可以直接把整個專案資料夾複製到另一台電腦，避免再次下載模型。

---

## 2) 怎麼啟用 server（WebSocket 伺服器）？

server 會負責：
- 接收 Windows client 的錄音資料
- Whisper 轉文字
- （可選）Vision 讀取截圖
- 用 Ollama 模型把文字整理好

### 方法 A：用一鍵啟動（推薦）

直接雙擊：
- `start_server.bat`

啟動成功後，你會看到類似訊息：
- `server listening on 127.0.0.1:8991`

### 方法 B：手動啟動

在專案資料夾開 PowerShell：

```powershell
$env:OLLAMA_URL='http://127.0.0.1:11434'
$env:LLM_MODEL='gemma3:4b'
$env:VISION_MODEL='qwen3-vl:8b-instruct'
$env:WHISPER_MODEL='large-v3-turbo'
$env:WHISPER_DOWNLOAD_ROOT="$PWD\models\whisper"

.venv\Scripts\python ws_server.py --host 127.0.0.1 --port 8991
```

---

## 3) 怎麼啟用 Windows client（語音輸入）？

Windows client 會做的事：
- 你按住熱鍵開始錄音
- 錄音中每 2 秒送一次累積音訊，讓你看到即時 partial
- 你放開熱鍵：送最後一包 + 結束訊號
- server 回傳最終結果後，client 會**自動貼上**到你正在輸入的地方（再可選擇按 Enter 送出）

### 方法 A：用一鍵啟動（推薦）

直接雙擊：
- `start_client.bat`

### 方法 B：手動啟動

```powershell
.venv\Scripts\python win_client.py --server ws://127.0.0.1:8991 --model gemma3:4b
```

### 使用方式（預設）

- **按住 F9**：開始錄音
- **放開 F9**：送出 → 自動貼上 →（預設會按 Enter）
- **按住 F8**：開始錄音
- **放開 F8**：送出 → 自動貼上（**不按 Enter**）
- **按一下 F10**：開啟連續錄音（持續收音）
- 連續錄音中會在 **約 10～20 秒** 內依據靜音自動送出一段文字
- **連續錄音中按一下 F11**：暫停收音（不關閉連續模式）
- **暫停中再按一下 F11**：恢復收音
- **再按一下 F10**：停止連續錄音

> 連續錄音可調參數：
> - `--no-enter-hotkey f8`：按住錄音，放開貼上但不按 Enter
> - `--toggle-hotkey f10`：切換式連續錄音熱鍵（按一次開始／再按一次停止）
> - `--pause-hotkey f11`：連續模式暫停/恢復熱鍵（不停止連續模式）
> - `--auto-segment-min 10`：最短分段秒數（達到後才會看靜音）
> - `--auto-segment-max 20`：最長分段秒數（到達就強制送出）
> - `--auto-segment-silence 1.2`：靜音多久視為可送出

> 熱鍵可以改：例如改成左 Alt
> 
> `python win_client.py --hotkey alt_l`

> 也可以改成 Ctrl / Shift，或組合鍵：
> - `python win_client.py --hotkey ctrl`
> - `python win_client.py --hotkey shift`
> - `python win_client.py --hotkey ctrl+shift`
> - `python win_client.py --hotkey ctrl_l+shift_l`（只用左邊 Ctrl/Shift）
>
> 不按 Enter 的熱鍵預設是 `--no-enter-hotkey f8`，可依習慣改成其他鍵。

> **如果你在 Microsoft Word 內使用 F8 時，畫面會自動全選/擴選（只剩最後一次貼上的文字）**
> - 這是 Word 的快捷鍵行為：`F8` =「延伸選取 (Extend Selection)」
> - 解法 A（推薦）：安裝 `keyboard` 套件後，client 會自動「攔截並抑制」F8，Word 就不會收到 F8
> - 解法 B：把熱鍵改成 `--hotkey f9`（或其他你習慣、不會被目標程式占用的鍵）

---

## 4) 注意事項（很重要）

1. **先開 server，再開 client**
   - client 需要連到 `ws://127.0.0.1:8991` 才能工作。

2. **自動貼上會貼到「目前焦點」的視窗**
   - 先用滑鼠點一下你要輸入文字的地方（例如：聊天框、記事本、IDE）。

3. **權限問題（貼不上/按鍵無效）**
   - 如果目標程式是「以系統管理員身分執行」，client 也可能需要用相同權限執行。

4. **麥克風裝置與取樣率**
   - 如果錄音沒聲音或有錯誤，通常是麥克風權限/裝置選擇問題。
   - 本工具用 16kHz / mono / int16。

5. **螢幕情境（截圖）會把整個畫面送去本機 Vision 模型**
   - 依然是本機（Ollama）處理，不上雲，但請注意畫面上若有敏感資訊。
   - 如果不想截圖：啟動 client 時加 `--no-screenshot`。

---

## 5) 如何修改輸入語系（預設是日文 ja）

這個專案的「語言提示」預設是 **日文 `ja`**（Windows client 會送給 server，server 再交給 Whisper 作為提示）。
如果你主要講的是其他語言，建議改成對應語系，辨識會更穩定。

### 方法 A：啟動 client 時指定（最簡單）

手動啟動時加上 `--language`：

```powershell
# 繁中 / 中文
.venv\Scripts\python win_client.py --server ws://127.0.0.1:8991 --model gemma3:4b --language zh

# 英文
.venv\Scripts\python win_client.py --server ws://127.0.0.1:8991 --model gemma3:4b --language en

# 韓文
.venv\Scripts\python win_client.py --server ws://127.0.0.1:8991 --model gemma3:4b --language ko
```

> 語言碼是提示用途（hint），不是 UI 語言。常用：`ja` / `zh` / `en` / `ko`。
>
> 注意：Whisper（faster-whisper）不支援 `zh-tw` 這種語言碼；繁體中文請直接用 `zh`。

### 方法 B：改一鍵啟動（start_client.bat）變成你要的預設

打開 `start_client.bat`，把最後一行改成加上 `--language zh`（或你要的語言碼）。

### 方法 C：改程式預設值（進階）

如果你希望不管怎麼啟動都預設某個語系，可以把 `win_client.py` 裡的 `--language` 預設從 `ja` 改成你要的語言碼。

---

## 6) 常見問題

### Q1：client 顯示「Not connected to server」
- 確認 server 已啟動，且顯示 `server listening on 127.0.0.1:8991`
- 確認防火牆沒有擋本機連線（通常不會）

### Q2：沒有自動貼上
- 確認你把游標焦點放在要輸入的視窗
- 試試看把目標程式與 client 都用同樣權限（一般/管理員）

### Q3：要停止 server / client
- 在各自的命令視窗按 `Ctrl+C`

